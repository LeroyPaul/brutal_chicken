<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" /><title>Poule</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.51.0/dist/phaser.js">
    </script>

    <style type="text/css"> body 
    
        { margin: 0; 
        }

    </style>
</head>
<body>
    <script type="text/javascript">

class scene1 extends Phaser.Scene{
    constructor(){
    super("scene1");
}



preload(){
    this.load.spritesheet('anim marche','assets/frame anim.png',{ frameWidth: 22, frameHeight: 36 });
    this.load.spritesheet('anim baisse','assets/baisser poule.png',{ frameWidth: 22, frameHeight: 36 });
    this.load.image("Phaser_tuilesdejeu", "assets/essai.png");

    this.load.tilemapTiledJSON("carte", "essaiTiled.json");  

    this.load.spritesheet('perso','assets/idle poule.png',{ frameWidth: 22, frameHeight: 36 });

}

create(){
    const carte = this.make.tilemap({ key: 'carte' });
    // importer les TileSet 
    const tileset = carte.addTilesetImage(
            "tuileTest",
            "Phaser_tuilesdejeu"
            );  

    const plateforme = carte.createLayer(
            "plateforme",
            tileset
            );

            this.velocity = 0

    ///////////////////////////////////////////////////////////////
    ///////////////////////////////////////////////////////////////
    ///////////////////////////////////////////////////////////////

    carte.getObjectLayer('spawnJoueur').objects.forEach((spawnJoueur) => {
        this.player = this.physics.add.sprite(spawnJoueur.x, spawnJoueur.y, 'perso').setOrigin(0);
        });

    this.player.body.setSize(16,30,true)
    this.player.setOffset(2, 4)
    
    this.physics.add.collider(this.player, plateforme);
    plateforme.setCollisionByProperty({ estSolide: true });

    this.player.setCollideWorldBounds(true);


    this.anims.create({
                key: 'animIdleGauche',
                frames: this.anims.generateFrameNumbers('perso', {start:0,end:5}),
                frameRate: 8,
                repeat: -1
            });
            this.anims.create({
                key: 'animIdleDroite',
                frames: this.anims.generateFrameNumbers('perso', {start:6,end:11}),
                frameRate: 8,
                repeat: -1
            });

    this.anims.create({
                key: 'animMarcheGauche',
                frames: this.anims.generateFrameNumbers('anim marche', {start:0,end:9}),
                frameRate: 8,
                repeat: -1
            });
            this.anims.create({
                key: 'animMarcheDroite',
                frames: this.anims.generateFrameNumbers('anim marche', {start:10,end:19}),
                frameRate: 8,
                repeat: -1
            });
            this.anims.create({
                key: 'animBaisseGauche',
                frames: this.anims.generateFrameNumbers('anim baisse', {start:3,end:7}),
                frameRate: 2,
                repeat: -1
            });
            this.anims.create({
                key: 'animBaisseContinuerGauche',
                frames: this.anims.generateFrameNumbers('anim baisse', {start:2,end:3}),
                frameRate: 8,
                repeat: -1
            });
            this.anims.create({
                key: 'animBaisseDroite',
                frames: this.anims.generateFrameNumbers('anim baisse', {start:5,end:6}),
                frameRate: 2,
                repeat: -1
            });
            this.anims.create({
                key: 'animBaisseContinuerDroite',
                frames: this.anims.generateFrameNumbers('anim baisse', {start:6,end:7}),
                frameRate: 8,
                repeat: -1
            });


    this.cameras.main.zoom = 2
    this.cameras.main.startFollow(this.player); 
    this.physics.world.setBounds(0, 0, 6400, 2880);
    this.cameras.main.setBounds(0, 0, 6400, 2880);
    
    this.timer = 0
    this.saut = 0
    this.player.direction = "right"
    this.baisse = false;

    this.oeufG = this.physics.add.group()

    

    this.physics.add.collider( this.oeufG,plateforme, this.destroyOeuf, null,this);


    ///////////////////////////////////////////////////////////////
    /////////////////////////TOUCHES///////////////////////////////
    ///////////////////////////////////////////////////////////////

    this.cursors = this.input.keyboard.createCursorKeys();
    this.keys = this.input.keyboard.addKeys({
        espace:  Phaser.Input.Keyboard.KeyCodes.SPACE,
        b: Phaser.Input.Keyboard.KeyCodes.B,

    });

    // touches spÃ©ciales clavier + manettes
    this.toucheF = this.input.keyboard.addKey('F') ||this.paddle.A;
    
}

update(time,delta){

    super.update(time,delta);


        this.justeUp = (this.cursors.up.isDown ) 
        this.moveUp = Phaser.Input.Keyboard.JustDown(this.keys.espace)
        this.plane = this.keys.espace.isDown
        this.tirer = Phaser.Input.Keyboard.JustDown(this.keys.b)
        this.moveLeft = (this.cursors.left.isDown )  
        this.moveRight = (this.cursors.right.isDown ) 
        this.moveDown = ( this.cursors.down.isDown) 
        if ( this.cursors.down.isUp) {this.baisse = false ;this.baisse2 = false}
        Phaser.Input.Keyboard.JustDown(this.keys.espace)

        if (this.player.body.blocked.down ) {
            this.saut = 0
        }

        //SAUT
        if(this.moveUp){
            this.saut += 1;
        }

        if (this.moveUp && this.player.body.blocked.down ) {
            this.player.setVelocityY(-420);}


        //PLANER
        if (this.plane){
            if (this.player.body.velocity.y > 0){
            this.player.setVelocityY(80)
            }
        }


        //OEUF
        if (this.tirer){
            this.oeuf = this.oeufG.create(this.player.x + 16, this.player.y, 'perso');
            this.oeuf.setVelocityY(-420)
            if (this.player.direction == "right"){
            this.oeuf.setVelocityX(this.velocity + 200)}
            if (this.player.direction == "left"){
            this.oeuf.setVelocityX(this.velocity + -200)}
        }

        //WALL JUMP    
        if (this.moveUp && this.player.body.blocked.left && this.moveLeft) {
            this.wallJumpGauche = true}

        if (this.wallJumpGauche == true){
            this.player.setVelocityX(this.velocity);
            this.velocity = 240
            this.player.setVelocityY(-220);
            this.timer += 1
            if (this.timer == 10){
            this.wallJumpGauche = false
            this.timer = 0}}

        if (this.moveUp && this.player.body.blocked.right && this.moveRight ) {
            this.wallJumpDroite = true}

        if (this.wallJumpDroite == true){
            this.player.setVelocityX(this.velocity);
            this.velocity = -240
            this.player.setVelocityY(-220);
            this.timer += 1
            if (this.timer == 10){
            this.wallJumpDroite = false
            this.timer = 0}}

        

        //DEPLACEMENT HORIZONTAL
        if (this.moveLeft){ 
            this.player.direction = 'left';
            this.player.anims.play('animMarcheGauche', true)
            this.player.body.setSize(16,30,true)
            this.player.setOffset(2, 6)
            this.player.setVelocityX(this.velocity); 
            if (this.velocity > -200){
                this.velocity -= 15;}
        }
        else if (this.moveRight){ 
            this.player.direction = 'right';
            this.player.anims.play('animMarcheDroite', true)
            this.player.body.setSize(16,30,true)
            this.player.setOffset(4, 6)
            this.player.setVelocityX(this.velocity);
                if (this.velocity <200){
                this.velocity += 15;}
        }



        //RALENTISSEMENT SUR LE SOL
        else{ 
            this.player.setVelocityX(this.velocity);
            if (this.player.body.blocked.down ) {
                if (this.velocity > 0){
                    this.velocity -=  30;
                    if (this.velocity < 30){
                        this. velocity = 0}}
                if (this.velocity < 0){
                    this.velocity +=  30;
                    if (this.velocity > 30){
                        this. velocity = 0}}
                        if (this.velocity == 0 && this.baisse == false){
                            if (this.player.direction == "left"){
                            this.player.anims.play('animIdleGauche', true)
                            this.player.body.setSize(16,30,true)
                            this.player.setOffset(2, 6)
                            }
                            if (this.player.direction == "right"){
                            this.player.anims.play('animIdleDroite', true)
                            this.player.body.setSize(16,30,true)
                            this.player.setOffset(4, 6)
                            }
                        }
            }
            
        //RALENTISSEMENT DANS L'AIR
            else {
                if (this.velocity > 0){
                    this.velocity -=  10;
                    if (this.velocity < 10){
                        this. velocity = 0}}
                if (this.velocity < 0){
                    this.velocity +=  10;
                    if (this.velocity > 10){
                        this.velocity = 0}}
            }
        }
        if (this.moveDown && this.player.body.velocity.y<500  ){
            (this.player.body.velocity.y)+=50;
        }
        

        

        if (this.moveDown && this.player.body.blocked.down){
            if(this.player.direction == "left"){
                this.player.anims.play('animBaisseGauche', true)
                this.player.body.setSize(18,10,true)
                this.player.setOffset(2, 25)}
            if(this.player.direction == "right"){
                this.player.anims.play('animBaisseDroite', true)
                this.player.body.setSize(18,10,true)
                this.player.setOffset(2, 25)}
            if(this.player.anims.currentFrame.index == 3 || this.player.anims.currentFrame.index == 7){
                this.baisse2 = true
            }

        }

        if (this.baisse2 == true){
            if(this.player.direction == "left"){
                this.player.anims.play('animBaisseContinuerGauche', true)
        }
            if(this.player.direction == "right"){
                this.player.anims.play('animBaisseContinuerDroite', true)
        }
    }
        

        //RALENTISSEMENT CONTRE LES MURS
        if (this.player.body.blocked.right ) {
            this.player.setVelocityX(this.velocity);
            this.velocity = 0;
            if ( this.player.body.velocity.y>50){
                this.player.setVelocityY(50)
                this.player.direction = "left"
            }
        }

        if (this.player.body.blocked.left ) {
            this.player.setVelocityX(this.velocity);
            this.velocity = 0;
            if ( this.player.body.velocity.y>50){
                this.player.setVelocityY(50)
                this.player.direction = "right"
            }
        }
     
    }
    destroyOeuf (oeuf,plateforme){
        oeuf.destroy();
    }   
};




var config = {
        type: Phaser.AUTO,
        width: 960, height: 540,
        physics: {
        default: 'arcade',
        arcade: {
        gravity: {y:1000},
        debug: true,
        }},
        pixelArt: true,
        fps: {
            target: 60,                    //bloc fps car update frame rate est selon frame rate du pc et donc changement des timings ( vitesse deplacement/tombe etc...)
            forceSetTimeOut: true
            },
        roundPixel: true,
        scene: [scene1]
        };
        new Phaser.Game(config);


</script>
</body>
</html>
