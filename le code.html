<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" /><title>Poule</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.51.0/dist/phaser.js">
    </script>

    <style type="text/css"> body 
    
        { margin: 0; 
        }

    </style>
</head>
<body>
    <script type="text/javascript">

class scene0 extends Phaser.Scene{
    constructor(){
    super("scene0");
}
preload(){

}
create(){
    this.spawnX = 1601
    this.spawnY = 800
}
update(){
    this.scene.start('scene1',{memoireX : this.spawnX , memoireY : this.spawnY})
}

};







class scene1 extends Phaser.Scene{
    constructor(){
    super("scene1");
}

init(data){
    this.spawnX = data.memoireX,
    this.spawnY = data.memoireY
}

preload(){
    this.load.spritesheet('anim marche','assets/frame anim.png',{ frameWidth: 22, frameHeight: 36 });
    this.load.spritesheet('anim baisse','assets/baisser poule.png',{ frameWidth: 22, frameHeight: 36 });
    this.load.image("Phaser_tuilesdejeu", "assets/essai.png");

    this.load.tilemapTiledJSON("carte", "essaiTiled.json");  

    this.load.spritesheet('perso','assets/idle poule.png',{ frameWidth: 22, frameHeight: 36 });
    this.load.spritesheet('idleScientifique','assets/idle scientifique.png',{ frameWidth: 21, frameHeight: 32 });

    this.load.spritesheet('anim baisser particule','assets/baisser particule.png',{ frameWidth: 71, frameHeight: 36 });
    this.load.spritesheet('anim planer','assets/planer.png',{ frameWidth: 22, frameHeight: 36 });
    this.load.spritesheet('anim descendre','assets/descendre mur.png',{ frameWidth: 16, frameHeight: 36 });
    this.load.spritesheet('tapis roulant milieu','assets/tapis roulant slot plat.png',{ frameWidth: 16, frameHeight: 16 });

    
    this.load.image("invisible", "assets/invisible.png");
    this.load.image("blocFragile", "assets/blocFragile.png");
    this.load.image("testFond", "assets/test fond.png");

    this.load.image("pique", "assets/pique.png");
    this.load.image("piqueBas", "assets/piqueBas.png");
    this.load.image("piqueGauche", "assets/piqueGauche.png");
    this.load.image("piqueDroite", "assets/piqueDroite.png");



}

create(){
    const carte = this.make.tilemap({ key: 'carte' });
    // importer les TileSet 
    const tileset = carte.addTilesetImage(
            "tuileTest",
            "Phaser_tuilesdejeu"
            );  

    const plateforme = carte.createLayer(
            "plateforme",
            tileset
            );

            this.velocity = 0

    ///////////////////////////////////////////////////////////////
    ///////////////////////////////////////////////////////////////
    ///////////////////////////////////////////////////////////////

    this.player = this.physics.add.sprite(this.spawnX, this.spawnY, 'perso')

  

    this.player.body.setSize(16,30,true)
    this.player.setOffset(2, 4)
    
    this.physics.add.collider(this.player, plateforme);
    plateforme.setCollisionByProperty({ estSolide: true });

    this.player.setCollideWorldBounds(true);


    this.anims.create({
                key: 'animIdleGauche',
                frames: this.anims.generateFrameNumbers('perso', {start:0,end:5}),
                frameRate: 8,
                repeat: -1
            });
            this.anims.create({
                key: 'animIdleDroite',
                frames: this.anims.generateFrameNumbers('perso', {start:6,end:11}),
                frameRate: 8,
                repeat: -1
            });

    this.anims.create({
                key: 'animMarcheGauche',
                frames: this.anims.generateFrameNumbers('anim marche', {start:0,end:9}),
                frameRate: 8,
                repeat: -1
            });
            this.anims.create({
                key: 'animMarcheDroite',
                frames: this.anims.generateFrameNumbers('anim marche', {start:10,end:19}),
                frameRate: 8,
                repeat: -1
            });
            this.anims.create({
                key: 'animBaisseGauche',
                frames: this.anims.generateFrameNumbers('anim baisse', {start:3,end:7}),
                frameRate: 2,
                repeat: -1
            });
            this.anims.create({
                key: 'animBaisseContinuerGauche',
                frames: this.anims.generateFrameNumbers('anim baisse', {start:2,end:3}),
                frameRate: 8,
                repeat: -1
            });
            this.anims.create({
                key: 'animBaisseDroite',
                frames: this.anims.generateFrameNumbers('anim baisse', {start:5,end:6}),
                frameRate: 2,
                repeat: -1
            });
            this.anims.create({
                key: 'animBaisseContinuerDroite',
                frames: this.anims.generateFrameNumbers('anim baisse', {start:6,end:7}),
                frameRate: 8,
                repeat: -1
            });
            this.anims.create({
                key: 'animBaisserParticule',
                frames: this.anims.generateFrameNumbers('anim baisser particule', {start:0,end:7}),
                frameRate: 8,
                repeat: -1
            });
            this.anims.create({
                key: 'planerGauche',
                frames: this.anims.generateFrameNumbers('anim planer', {start:0,end:2}),
                frameRate: 16,
                repeat: -1
            });
            this.anims.create({
                key: 'planerDroite',
                frames: this.anims.generateFrameNumbers('anim planer', {start:3,end:5}),
                frameRate: 16,
                repeat: -1
            });
            this.anims.create({
                key: 'animdescendreMurDroite',
                frames: this.anims.generateFrameNumbers('anim descendre', {start:0,end:3}),
                frameRate: 8,
                repeat: -1
            });
            this.anims.create({
                key: 'animdescendreMurGauche',
                frames: this.anims.generateFrameNumbers('anim descendre', {start:4,end:7}),
                frameRate: 8,
                repeat: -1
            });
            this.anims.create({
                key: 'animIdleScientifique',
                frames: this.anims.generateFrameNumbers('idleScientifique', {start:0,end:5}),
                frameRate: 8,
                repeat: -1
            });
            this.anims.create({
                key: 'animTapisRoulantMilieu',
                frames: this.anims.generateFrameNumbers('tapis roulant milieu', {start:0,end:3}),
                frameRate: 8,
                repeat: -1
            });



    this.cameras.main.zoom = 2
    this.physics.world.setBounds(0, 0, 6400, 1600);
    this.cameras.main.setBounds(0, 0, 6400, 1600);
    
    this.timer = 0

    this.compteur = 0
    this.saut = 0
    this.player.direction = "right"
    this.baisse = false;
    this.bouge = false
    this.blocFragileBool = false

    this.oeufG = this.physics.add.group()

    

    this.physics.add.collider( this.oeufG,plateforme, this.destroyOeuf, null,this);






    this.scientifiqueGroupe = this.physics.add.group()


carte.getObjectLayer('scientifiqueLayer').objects.forEach((scientifiqueGroupe) => {
this.scientifique = this.scientifiqueGroupe.create(scientifiqueGroupe.x  , scientifiqueGroupe.y - 16, 'idleScientifique');
this.scientifique.anims.play('animIdleScientifique',true)
this.scientifique.setSize(21, 20);
this.scientifique.setOffset(0, 11);
this.scientifique.setPushable(false);




});



//camera déclaration

carte.getObjectLayer('camera1').objects.forEach((camera1) => {
this.camera1 = this.physics.add.image(camera1.x , camera1.y , 'invisible')
this.camera1.body.setAllowGravity(false)
});
carte.getObjectLayer('camera2').objects.forEach((camera2) => {
this.camera2 = this.physics.add.image(camera2.x , camera2.y , 'invisible')
this.camera2.body.setAllowGravity(false)
});
carte.getObjectLayer('camera3').objects.forEach((camera3) => {
this.camera3 = this.physics.add.image(camera3.x , camera3.y , 'invisible')
this.camera3.body.setAllowGravity(false)
});
carte.getObjectLayer('camera4').objects.forEach((camera4) => {
this.camera4 = this.physics.add.image(camera4.x , camera4.y , 'invisible')
this.camera4.body.setAllowGravity(false)
});
carte.getObjectLayer('camera5').objects.forEach((camera5) => {
this.camera5 = this.physics.add.image(camera5.x , camera5.y , 'invisible')
this.camera5.body.setAllowGravity(false)
});
carte.getObjectLayer('camera6').objects.forEach((camera6) => {
this.camera6 = this.physics.add.image(camera6.x , camera6.y , 'invisible')
this.camera6.body.setAllowGravity(false)
});
carte.getObjectLayer('camera7').objects.forEach((camera7) => {
this.camera7 = this.physics.add.image(camera7.x , camera7.y , 'invisible')
this.camera7.body.setAllowGravity(false)
});



//blocFragile

this.blocFragileGroupe = this.physics.add.group()

carte.getObjectLayer('blocFragile').objects.forEach((blocFragileGroupe) => {
this.blocFragile = this.blocFragileGroupe.create(blocFragileGroupe.x + 8 , blocFragileGroupe.y-8 , 'blocFragile')
this.blocFragile.body.setAllowGravity(false)
this.blocFragile.setPushable(false);

});


//tapis roulant

this.tapisRoulantGroupe = this.physics.add.group()

carte.getObjectLayer('tapisRoulantMilieu').objects.forEach((tapisRoulantGroupe) => {
this.tapisRoulantMilieu = this.tapisRoulantGroupe.create(tapisRoulantGroupe.x+8, tapisRoulantGroupe.y-8 , 'tapis roulant milieu')
this.tapisRoulantMilieu.anims.play('animTapisRoulantMilieu',true)
this.tapisRoulantMilieu.body.setAllowGravity(false)
this.tapisRoulantMilieu.setPushable(false);

});


//pique

this.piqueGroupe = this.physics.add.group()

carte.getObjectLayer('piqueLayer').objects.forEach((piqueGroupe) => {
this.pique = this.piqueGroupe.create(piqueGroupe.x+8 , piqueGroupe.y-8 , 'pique')
this.pique.body.setAllowGravity(false)
this.pique.setPushable(false);
});
carte.getObjectLayer('piqueBasLayer').objects.forEach((piqueGroupe) => {
this.piqueBas = this.piqueGroupe.create(piqueGroupe.x+8 , piqueGroupe.y-8 , 'piqueBas')
this.piqueBas.body.setAllowGravity(false)
this.piqueBas.setPushable(false);
});

carte.getObjectLayer('piqueGaucheLayer').objects.forEach((piqueGroupe) => {
this.piqueGauche = this.piqueGroupe.create(piqueGroupe.x+8 , piqueGroupe.y-8 , 'piqueGauche')
this.piqueGauche.body.setAllowGravity(false)
this.piqueGauche.setPushable(false);
});

carte.getObjectLayer('piqueDroiteLayer').objects.forEach((piqueGroupe) => {
this.piqueDroite = this.piqueGroupe.create(piqueGroupe.x+8 , piqueGroupe.y-8 , 'piqueDroite')
this.piqueDroite.body.setAllowGravity(false)
this.piqueDroite.setPushable(false);
});


this.physics.add.collider(this.player, this.blocFragileGroupe,this.destroyBlocFragile, null, this);
this.physics.add.collider(this.player, this.tapisRoulantGroupe, this.tapis, null,this);
this.physics.add.collider(this.scientifiqueGroupe, plateforme);
this.physics.add.collider( this.oeufG, this.scientifiqueGroupe, this.destroyOeuf, null,this);
this.physics.add.collider( this.player, this.scientifiqueGroupe, this.destroyPlayer, null,this);





    ///////////////////////////////////////////////////////////////
    /////////////////////////TOUCHES///////////////////////////////
    ///////////////////////////////////////////////////////////////

    this.cursors = this.input.keyboard.createCursorKeys();
    this.keys = this.input.keyboard.addKeys({
        espace:  Phaser.Input.Keyboard.KeyCodes.SPACE,
        b: Phaser.Input.Keyboard.KeyCodes.B,

    });

    // touches spéciales clavier + manettes
    this.toucheF = this.input.keyboard.addKey('F') ||this.paddle.A;
}


















update(time,delta){
//camera
//+ 640

    







    super.update(time,delta);


    if (this.player.x < 640){
        this.cameras.main.startFollow(this.camera1);
        this.respawnX = 32
        this.respawnY = 1490}
    if (this.player.x > 640 && this.player.x < 1280){
        this.cameras.main.startFollow(this.camera2);
        this.respawnX = 672
        this.respawnY = 1470}
    if (this.player.x > 1280 && this.player.x < 1920 && this.player.y > 1000){
        this.cameras.main.startFollow(this.camera3);
        if (this.camera3.y > this.player.y +100){
            this.camera3.y -= 1
        }
        if (this.camera3.y < this.player.y + 20 ){
            this.camera3.y += 1
        }
        this.respawnX = 1314
        this.respawnY = 1375
    }
    if (this.player.x > 1920 && this.player.x < 2560 && this.player.y > 1200){
        this.cameras.main.startFollow(this.camera4);
        this.respawnX = 1950
        this.respawnY = 1495}

    if (this.player.x > 2320 && this.player.x < 2940 && this.player.y < 1200){
        this.cameras.main.startFollow(this.camera5);
        if (this.camera5.y > this.player.y +100){
            this.camera5.y -= 1}
            if (this.camera5.y < this.player.y + 20 && this.camera5.y < 1025 ){
            this.camera5.y += 2
        }
        this.respawnX = 2423
        this.respawnY = 1155
    }

    if (this.player.x > 1680 && this.player.x < 2320 && this.player.y < 1000){
    this.cameras.main.startFollow(this.camera6); }

    if (this.player.x >1040  && this.player.x < 1680 && this.player.y < 1000 ){
    this.cameras.main.startFollow(this.camera7); 
        if (this.camera7.y > this.player.y +100){
            this.camera7.y -= 1}
            if (this.camera7.y < this.player.y + 20 && this.camera7.y < 750 ){
                this.camera7.y += 2
        }}
            


        this.justeUp = (this.cursors.up.isDown ) 
        this.isUp = (this.cursors.up.isUp ) 
        this.moveUp = Phaser.Input.Keyboard.JustDown(this.cursors.up)
        this.plane = this.cursors.up.isDown
        this.tirer = Phaser.Input.Keyboard.JustDown(this.keys.b)
        this.moveLeft = (this.cursors.left.isDown )  
        this.moveRight = (this.cursors.right.isDown ) 
        this.moveDown = ( this.cursors.down.isDown) 
        if ( this.cursors.down.isUp) {this.baisse = false ;this.baisse2 = false}
        Phaser.Input.Keyboard.JustDown(this.keys.espace)

        if (this.player.body.blocked.down ) {
            this.saut = 0
        }

        //SAUT

        if(this.isUp){
            if (this.timerJump > 50){
}
            this.saut += 1;


        }

        if (this.moveUp && this.player.body.blocked.down ) {
            this.player.setVelocityY(-420)
            //this.player.setTint(0xff0000);
            
        this.timerJump += 1
}


        //PLANER
        if (!this.player.body.blocked.down) {
        if (!this.player.body.blocked.right && !this.player.body.blocked.left){
            if (this.plane){//plane
                    if (this.player.body.velocity.y > 0){
                    this.player.setVelocityY(80)
                    if(this.player.direction == "left")
                        this.player.anims.play('planerGauche', true)
                        if(this.player.direction == "right")
                        this.player.anims.play('planerDroite', true)
                    }
                }
            else {//idle dans le ciel
                if(this.player.direction == "right")
                this.player.anims.play('animMarcheDroite', true)


                if(this.player.direction == "left")
                this.player.anims.play('animMarcheGauche', true)

            }
        }
        else {//descendre contre le mur
            if(this.player.direction == "left")
            this.player.anims.play('animdescendreMurDroite', true)
            this.player.body.setSize(16,30,true)
                this.player.setOffset(6, 0)
                if(this.player.direction == "right")
            this.player.anims.play('animdescendreMurGauche', true)
            this.player.body.setSize(16,30,true)
                this.player.setOffset(0, 6)
        }
    }


        //OEUF
        if (this.tirer){
            this.oeuf = this.oeufG.create(this.player.x + 16, this.player.y, 'perso');
            this.oeuf.setVelocityY(-420)
            if (this.player.direction == "right"){
            this.oeuf.setVelocityX(this.velocity + 200)}
            if (this.player.direction == "left"){
            this.oeuf.setVelocityX(this.velocity + -200)}
        }

        //WALL JUMP    
        if (this.moveUp && this.player.body.blocked.left && this.moveLeft) {
            this.wallJumpGauche = true}

        if (this.wallJumpGauche == true){
            this.player.setVelocityX(this.velocity);
            this.velocity = 240
            this.player.setVelocityY(-220);
            this.timer += 1
            if (this.timer == 20){
            this.wallJumpGauche = false
            this.timer = 0}}

        if (this.moveUp && this.player.body.blocked.right && this.moveRight ) {
            this.wallJumpDroite = true}

        if (this.wallJumpDroite == true){
            this.player.setVelocityX(this.velocity);
            this.velocity = -240
            this.player.setVelocityY(-220);
            this.timer += 1
            if (this.timer == 20){
            this.wallJumpDroite = false
            this.timer = 0}}

        

        //DEPLACEMENT HORIZONTAL
        if (this.moveLeft){ 
            if (!this.player.body.blocked.left){
            this.player.direction = 'left';}
            if (this.player.body.blocked.down){
                this.player.anims.play('animMarcheGauche', true)
                this.player.body.setSize(16,30,true)
                this.player.setOffset(2, 6)}
            this.player.setVelocityX(this.velocity); 
            if (this.velocity > -200){
                this.velocity -= 7.5;}
        }
        else if (this.moveRight){ 
            if (!this.player.body.blocked.right){
            this.player.direction = 'right';}
            if (this.player.body.blocked.down){
            this.player.anims.play('animMarcheDroite', true)
            this.player.body.setSize(16,30,true)
            this.player.setOffset(4, 6)}
            this.player.setVelocityX(this.velocity);
                if (this.velocity <200){
                this.velocity += 7.5;}
        }


        //RALENTISSEMENT SUR LE SOL ET IDLE
        else{ 
            this.player.setVelocityX(this.velocity);
            if (this.player.body.blocked.down ) {
                if (this.velocity > 0){
                    this.velocity -=  15;
                    if (this.velocity < 15){
                        this. velocity = 0}}
                if (this.velocity < 0){
                    this.velocity +=  15;
                    if (this.velocity > 15){
                        this. velocity = 0}}
                        if (this.velocity == 0 && this.baisse == false){
                            if (this.player.direction == "left"){
                            this.player.anims.play('animIdleGauche', true)
                            this.player.body.setSize(16,30,true)
                            this.player.setOffset(2, 6)
                            }
                            if (this.player.direction == "right"){
                            this.player.anims.play('animIdleDroite', true)
                            this.player.body.setSize(16,30,true)
                            this.player.setOffset(4, 6)
                            }
                        }
            }
            
        //RALENTISSEMENT DANS L'AIR
            else {
                if (this.velocity > 0){
                    this.velocity -=  5;
                    if (this.velocity < 10){
                        this. velocity = 0}}
                if (this.velocity < 0){
                    this.velocity +=  5;
                    if (this.velocity > 10){
                        this.velocity = 0}}
            }
        }
        if (this.moveDown && this.player.body.velocity.y<500  ){
            (this.player.body.velocity.y)+=25;
        }
        

        

        if (this.moveDown){
            if(this.player.direction == "left"){
                this.player.anims.play('animBaisseGauche', true)
                this.player.body.setSize(18,10,true)
                this.player.setOffset(2, 25)}
            if(this.player.direction == "right"){
                this.player.anims.play('animBaisseDroite', true)
                this.player.body.setSize(18,10,true)
                this.player.setOffset(2, 25)}
            if(this.player.anims.currentFrame.index == 3 || this.player.anims.currentFrame.index == 7){
                this.baisse2 = true
            }

        }

        if (this.baisse2 == true){
            if(this.player.direction == "left"){
                this.player.anims.play('animBaisseContinuerGauche', true)
        }
            if(this.player.direction == "right"){
                this.player.anims.play('animBaisseContinuerDroite', true)
        }
    }
        

        //RALENTISSEMENT CONTRE LES MURS
        if (this.player.body.blocked.right ) {
            this.player.setVelocityX(this.velocity);
            this.velocity = 0;
            if ( this.player.body.velocity.y>50){
                this.player.setVelocityY(50)
                this.player.direction = "left"
            }
        }

        if (this.player.body.blocked.left ) {
            this.player.setVelocityX(this.velocity);
            this.velocity = 0;
            if ( this.player.body.velocity.y>50){
                this.player.setVelocityY(50)
                this.player.direction = "right"
                
                
            }
        }



this.memoireX = this.player.x
this.memoireY = this.player.y

     
        this.scientifiqueGroupe.children.each(function(enemy) {
            if (this.player.x > enemy.x - 30 && this.player.x < enemy.x + 20 && this.player.y< enemy.y - 30 && this.player.y> enemy.y - 40)//check si le perso saute dessus
            {enemy.destroy();
                this.player.setVelocityY(-420)
                this.cameras.main.shake(50, 0.01);
            }
        }, this); 




/*        this.blocFragileGroupe.children.each(function(blocFragile) {
            if (this.player.x > blocFragile.x - 30 && this.player.x < blocFragile.x+6 && this.player.y< blocFragile.y - 30 && this.player.y> blocFragile.y - 60)//check si le perso saute dessus
                {this.blocFragileBool = true
                if (this.blocFragileBool == true){
                this.compteur += 1
                if (this.compteur == 50){
                    blocFragile.destroy();
                    this.compteur = 0
                    this.blocFragileBool = false}
                }
                }
        }, this); */


        this.tapisRoulantGroupe.children.each(function(tapis) {
            if (this.player.x > tapis.x - 30 && this.player.x < tapis.x+6 && this.player.y< tapis.y - 30 && this.player.y> tapis.y - 60)//check si le perso saute dessus
            {
                this.player.setVelocityX(this.velocity + 100)

            }
        }, this); 

        this.piqueGroupe.children.each(function(pique) {
            if (this.player.x > pique.x - 24 && this.player.x < pique.x+4 && this.player.y< pique.y && this.player.y> pique.y - 15)//check si le perso saute dessus
            {

    this.scene.start('scene1',{memoireX : this.respawnX , memoireY : this.respawnY})
            }
        }, this); 





    }
    destroyOeuf (oeuf,plateforme){
        oeuf.destroy();
    }   

    destroyPlayer (player,scientifiqueGroupe){
        this.cameras.main.shake(100, 0.01);
        this.scientif = this.physics.closest(this.player)
        if (this.scientif.x < this.player.x){}
    }   

    destroyBlocFragile (player,blocFragileGroupe){
        this.sleep = (milliseconds) =>{
            return new Promise(resolve => setTimeout(resolve,milliseconds));}

        this.sleep(500).then(() => {
blocFragileGroupe.destroy();
        })

    }

    tapis (player,tapisRoulantGroupe){ }


};




var config = {
        type: Phaser.AUTO,
        width: 1280, height: 720,
        physics: {
        default: 'arcade',
        arcade: {
        gravity: {y:1000},
        debug: true,
        }},
        pixelArt: true,
        fps: {
            target: 120,                    //bloc fps car update frame rate est selon frame rate du pc et donc changement des timings ( vitesse deplacement/tombe etc...)
            forceSetTimeOut: true
            },
        roundPixel: true,
        scene: [scene0,scene1]
        };
        new Phaser.Game(config);


</script>
</body>
</html>
